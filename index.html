<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E&C COMMAND CENTER</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffcc00">
    
    <style>
        :root { --accent: #ffcc00; --bg: #0a0a0a; --card: #161616; --text: #eee; --wpg: #2196f3; --brdn: #9c27b0; --active-green: #00ff41; --archive-orange: #ff6600; --note-blue: #00d4ff; --pro-blue: #007bff; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; }
        
        header { padding: 10px 15px; background: #000; border-bottom: 3px solid var(--accent); display: flex; justify-content: space-between; align-items: center; position: relative; }
        
        .header-logo {
            height: 22px;
            width: auto;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Marker Pulsing Animation */
        @keyframes markerPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pulsing-marker {
            animation: markerPulse 2s infinite ease-in-out;
        }

        h1 { margin: 0; font-size: 20px; font-weight: 900; color: var(--accent); letter-spacing: 1px; display: flex; align-items: center; }
        
        #stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; background: #111; border-bottom: 1px solid #222; }
        .stat-box { background: var(--card); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #333; position: relative; overflow: hidden; }
        .stat-box h3 { margin: 0; font-size: 10px; text-transform: uppercase; color: #888; }
        .stat-box p { margin: 5px 0 0; font-size: 24px; font-weight: 900; color: var(--accent); }
        
        .unassigned-glow { border-color: var(--accent) !important; box-shadow: 0 0 15px rgba(255, 204, 0, 0.3); }
        .high-alert { animation: alertPulse 1.5s infinite; }
        @keyframes alertPulse { 0% { background: #161616; } 50% { background: #332200; } 100% { background: #161616; } }

        #note-box { margin: 10px; padding: 12px; background: rgba(0, 212, 255, 0.1); border: 1px solid var(--note-blue); border-radius: 8px; display: none; }
        #note-list { margin: 0; padding: 0; list-style: none; font-size: 14px; color: var(--note-blue); font-weight: bold; }

        #main-feed { padding: 10px; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .job-card { background: var(--card); border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; }
        .card-header { padding: 10px 15px; background: #1c1c1c; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .city-badge { font-weight: 900; font-size: 14px; text-transform: uppercase; padding: 4px 10px; border-radius: 4px; color: #fff; }
        .city-wpg { background: var(--wpg); } .city-brdn { background: var(--brdn); } .city-other { background: #555; }
        .time-label { font-size: 12px; font-weight: bold; color: #888; }

        .card-body { padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .location-row { display: flex; align-items: flex-start; gap: 10px; }
        .loc-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
        .pickup-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
        .drop-dot { background: #555; }
        .address-text { font-size: 17px; font-weight: 800; color: #fff; line-height: 1.2; }
        .sub-address { font-size: 13px; color: #aaa; font-weight: normal; display: block; }

        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #222; }
        .detail-item { font-size: 13px; color: #888; }
        .detail-val { font-size: 14px; font-weight: bold; color: #ddd; display: block; }

        .card-footer { padding: 10px; background: #1c1c1c; display: flex; gap: 10px; }
        .assign-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 900; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        .btn-unassigned { background: var(--accent); color: #000; }
        .btn-assigned { background: #333; color: var(--active-green); border: 1px solid var(--active-green); }
        
        #history-section { background: #000; padding: 20px 10px; border-top: 2px solid #222; }
        .history-title { font-size: 14px; font-weight: 900; text-transform: uppercase; color: #555; margin-bottom: 10px; padding-left: 5px; }
        .history-item { background: #111; padding: 12px; border-radius: 8px; border-left: 4px solid var(--active-green); margin-bottom: 8px; font-size: 13px; cursor: pointer; }
        .hist-city { font-weight: 900; color: var(--accent); margin-right: 8px; }
        .hist-name { color: #888; }
        .hist-time { font-size: 11px; color: #555; margin-top: 4px; text-transform: uppercase; }
        .hist-driver { float: right; font-weight: 900; color: var(--active-green); }

        #driver-map-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        #map-canvas { flex: 1; width: 100%; }
        .map-controls { padding: 15px; background: #000; border-top: 2px solid var(--accent); display: flex; justify-content: space-between; }
        .close-map-btn { padding: 12px 25px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: 900; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 10px; z-index: 900; }
        .nav-btn { background: none; border: none; color: #666; font-size: 11px; font-weight: 900; text-transform: uppercase; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-btn-active { color: var(--accent); }
        .nav-icon { font-size: 20px; }

        #load-more-btn { width: 100%; padding: 15px; background: transparent; border: 1px dashed #333; color: #555; border-radius: 8px; font-weight: 900; cursor: pointer; margin-top: 10px; }
        
        /* Modal for driver assignment */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .driver-modal { background: #161616; border: 2px solid var(--accent); width: 100%; max-width: 300px; border-radius: 15px; padding: 20px; }
        .driver-option { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; text-align: center; font-weight: 900; color: #fff; cursor: pointer; border: 1px solid #333; }
        .driver-option:active { background: var(--accent); color: #000; }
    </style>
</head>
<body>

<header>
    <h1>
        <img src="icon-512.png" class="header-logo" alt="Logo">
        COMMAND CENTER
    </h1>
    <div style="font-size: 12px; font-weight: 900; color: #555;" id="current-time">00:00:00</div>
</header>

<div id="stats-bar">
    <div class="stat-box" id="pending-box">
        <h3>Pending</h3>
        <p id="stat-pending">0</p>
    </div>
    <div class="stat-box">
        <h3>Assigned</h3>
        <p id="stat-assigned">0</p>
    </div>
    <div class="stat-box">
        <h3>Notes</h3>
        <p id="stat-note">0</p>
    </div>
</div>

<div id="note-box">
    <ul id="note-list"></ul>
</div>

<div id="main-feed"></div>

<div id="history-section">
    <div class="history-title">Recent Activity</div>
    <div id="archived-list"></div>
    <button id="load-more-btn" onclick="increaseLimit()">Load More Activity</button>
</div>

<div id="driver-map-overlay">
    <div id="map-canvas"></div>
    <div class="map-controls">
        <div id="map-legend" style="font-size: 12px; color: #888; display: flex; align-items: center; gap: 10px;">
            <span style="color: var(--active-green)">‚óè Live Tracking</span>
        </div>
        <button class="close-map-btn" onclick="closeMap()">CLOSE MAP</button>
    </div>
</div>

<div id="modal-overlay">
    <div class="driver-modal" id="driver-selector-box"></div>
</div>

<nav>
    <button class="nav-btn nav-btn-active" onclick="location.reload()">
        <span class="nav-icon">üìã</span> Feed
    </button>
    <button class="nav-btn" onclick="openMap()">
        <span class="nav-icon">üìç</span> Map
    </button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
        authDomain: "eandccourier-36fcc.firebaseapp.com",
        databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
        projectId: "eandccourier-36fcc"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously();
    const db = firebase.database();

    const DRIVERS = ["Matt", "Touch", "Julian", "Jess"];
    let archiveLimit = 5;
    let mainMap = null;
    let mapMarkers = {};
    let lastKnownCompletedId = null;

    function increaseLimit() { archiveLimit += 10; }

    function updateTime() {
        const now = new Date();
        document.getElementById('current-time').innerText = now.toLocaleTimeString();
    }
    setInterval(updateTime, 1000);

    // --- MAP LOGIC MODIFIED FOR PULSING GREEN DOTS ---
    function openMap() {
        document.getElementById('driver-map-overlay').style.display = 'flex';
        if (!mainMap) {
            mainMap = new google.maps.Map(document.getElementById('map-canvas'), {
                center: { lat: 49.8951, lng: -97.1384 },
                zoom: 11,
                styles: [
                    { "elementType": "geometry", "stylers": [{ "color": "#212121" }] },
                    { "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] },
                    { "elementType": "labels.text.fill", "stylers": [{ "color": "#757575" }] },
                    { "elementType": "labels.text.stroke", "stylers": [{ "color": "#212121" }] },
                    { "featureType": "administrative", "elementType": "geometry", "stylers": [{ "color": "#757575" }] },
                    { "featureType": "road", "elementType": "geometry.fill", "stylers": [{ "color": "#2c2c2c" }] },
                    { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#000000" }] }
                ],
                disableDefaultUI: true
            });
        }

        db.ref("driver_locations").on("value", snapshot => {
            const locs = snapshot.val() || {};
            DRIVERS.forEach(name => {
                const driver = locs[name];
                if (!driver || !driver.lat) return;

                const pos = { lat: driver.lat, lng: driver.lng };
                const updateTS = driver.gps_timestamp || driver.last_seen || driver.timestamp;
                const timeStr = updateTS ? new Date(updateTS).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                const markerLabel = `${name} ${timeStr}`;

                if (mapMarkers[name]) {
                    mapMarkers[name].setPosition(pos);
                    mapMarkers[name].setLabel({
                        text: markerLabel,
                        color: "#00ff41",
                        fontWeight: "900",
                        fontSize: "14px",
                        className: "pulsing-marker" // Apply pulsing class to label container
                    });
                } else {
                    mapMarkers[name] = new google.maps.Marker({
                        position: pos,
                        map: mainMap,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#00ff41',
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: '#ffffff',
                            scale: 6,
                            labelOrigin: new google.maps.Point(0, -2)
                        },
                        label: {
                            text: markerLabel,
                            color: "#00ff41",
                            fontWeight: "900",
                            fontSize: "14px",
                            className: "pulsing-marker"
                        },
                        title: name
                    });
                }
            });
        });
    }

    function closeMap() {
        document.getElementById('driver-map-overlay').style.display = 'none';
        db.ref("driver_locations").off();
    }

    // --- MAIN FEED & LOGIC ---
    function showDriverSelector(jobId) {
        const modal = document.getElementById('modal-overlay');
        const box = document.getElementById('driver-selector-box');
        modal.style.display = 'flex';
        box.innerHTML = `<h2 style="color:var(--accent); text-align:center; margin-top:0;">Assign Driver</h2>`;
        
        DRIVERS.forEach(d => {
            const opt = document.createElement('div');
            opt.className = 'driver-option';
            opt.innerText = d;
            opt.onclick = () => {
                assignDriver(jobId, d);
                modal.style.display = 'none';
            };
            box.appendChild(opt);
        });

        const cancel = document.createElement('div');
        cancel.className = 'driver-option';
        cancel.style.background = '#444';
        cancel.innerText = 'Unassign / Cancel';
        cancel.onclick = () => {
            unassign(jobId);
            modal.style.display = 'none';
        };
        box.appendChild(cancel);
    }

    db.ref("pickups").on("value", snapshot => {
        const data = snapshot.val() || {};
        renderFeed(data);
    });

    function renderFeed(data) {
        const feed = document.getElementById("main-feed");
        const histList = document.getElementById("archived-list");
        const noteList = document.getElementById("note-list");
        feed.innerHTML = ""; histList.innerHTML = ""; noteList.innerHTML = "";

        let pending = 0, assignedCount = 0, noteCount = 0;
        const archivedJobs = [];

        Object.entries(data).forEach(([id, p]) => {
            if (p.status === 'completed') {
                archivedJobs.push({ ...p, id });
                return;
            }

            if (p.assigned_to === "Unassigned" || !p.assigned_to) pending++;
            else assignedCount++;

            if (p.other_info && p.other_info.trim().length > 0) {
                noteCount++;
                const li = document.createElement("li");
                li.innerText = `[${p.city || '??'}] ${p.other_info}`;
                noteList.appendChild(li);
            }

            const cityClass = p.city === 'Winnipeg' ? 'city-wpg' : (p.city === 'Brandon' ? 'city-brdn' : 'city-other');
            const card = document.createElement("div");
            card.className = "job-card";
            card.innerHTML = `
                <div class="card-header">
                    <span class="city-badge ${cityClass}">${p.city || 'Other'}</span>
                    <span class="time-label">${new Date(p.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="card-body">
                    <div class="location-row">
                        <div class="loc-dot pickup-dot"></div>
                        <div class="address-text">${p.pickup_location}<span class="sub-address">${p.name || 'No Contact'}</span></div>
                    </div>
                    <div class="location-row">
                        <div class="loc-dot drop-dot"></div>
                        <div class="address-text" style="font-size:14px; color:#aaa;">${p.destination}</div>
                    </div>
                    <div class="details-grid">
                        <div class="detail-item">TYPE<span class="detail-val">${p.package_type}</span></div>
                        <div class="detail-item">SIZE<span class="detail-val">${p.dimensions?.length}x${p.dimensions?.width}x${p.dimensions?.height}</span></div>
                    </div>
                    ${p.other_info ? `<div style="margin-top:8px; font-size:12px; color:var(--note-blue); font-weight:bold;">NOTE: ${p.other_info}</div>` : ''}
                </div>
                <div class="card-footer">
                    <button class="assign-btn ${p.assigned_to && p.assigned_to !== 'Unassigned' ? 'btn-assigned' : 'btn-unassigned'}" onclick="showDriverSelector('${id}')">
                        ${p.assigned_to && p.assigned_to !== 'Unassigned' ? p.assigned_to : 'Assign Driver'}
                    </button>
                    <button class="assign-btn" style="background:#222; color:#ff4444; flex:0 0 50px;" onclick="deleteJob('${id}')">‚úï</button>
                </div>
            `;
            feed.appendChild(card);
        });

        // Archive logic
        archivedJobs.sort((a, b) => b.completed_at - a.completed_at);
        const currentTopArchivedId = archivedJobs.length > 0 ? archivedJobs[0].id : null;
        
        archivedJobs.slice(0, archiveLimit).forEach(p => {
            const hItem = document.createElement("div");
            hItem.className = "history-item";
            const inTime = new Date(p.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const outTime = new Date(p.completed_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            hItem.innerHTML = `
                <span class="hist-driver">${p.assigned_to}</span>
                <div><span class="hist-city">${p.city || '??'}</span><span class="hist-name">${p.name || ''}</span></div>
                <div style="margin-top:4px;">${p.pickup_location.split(',')[0]}</div>
                <div class="hist-time">In: ${inTime} | Out: ${outTime}</div>
            `;
            histList.appendChild(hItem);
        });

        document.getElementById('stat-pending').innerText = pending;
        document.getElementById('stat-assigned').innerText = assignedCount;
        document.getElementById('stat-note').innerText = noteCount;
        document.getElementById('note-box').style.display = noteCount > 0 ? 'block' : 'none';
        if (pending > 0) document.getElementById('pending-box').classList.add('high-alert');
        else document.getElementById('pending-box').classList.remove('high-alert');
    }

    function assignDriver(id, driver) { db.ref("pickups").child(id).update({ assigned_to: driver }); }
    function unassign(id) { db.ref("pickups").child(id).update({ assigned_to: 'Unassigned' }); }
    function deleteJob(id) { if (confirm("Delete this job?")) db.ref("pickups").child(id).remove(); }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDltbEbiqlyQjyaGth0AzIkfLpOYr96YeQ&libraries=geometry"></script>

</body>
</html>
