<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E&C COMMAND CENTER</title>
    <style>
        :root {
            --accent: #ffcc00;
            --bg: #0a0a0a;
            --card: #161616;
            --text: #eee;
            --wpg: #2196f3;
            --brdn: #9c27b0;
            --active-green: #00ff41; 
        }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        header { padding: 10px 15px; background: #000; border-bottom: 3px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { display: flex; background: #111; padding: 15px 5px; border-bottom: 1px solid #333; justify-content: space-around; align-items: center; }
        .stat-box { text-align: center; flex: 1; position: relative; }
        .stat-label { display: block; font-size: 11px; color: #888; font-weight: 900; text-transform: uppercase; margin-bottom: 4px; }
        .stat-number { font-family: 'Courier New', monospace; font-weight: 900; line-height: 1; position: relative; z-index: 2; }
        #stat-pending { font-size: 48px; color: var(--accent); }
        .high-alert #stat-pending { color: #fff; text-shadow: 0 0 15px var(--active-green); animation: pulse 0.8s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        #board-panel { padding: 15px; flex: 1; }
        #entry-panel { background: #0f0f0f; border-top: 2px solid #333; padding: 20px 15px 40px 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 600px) { .form-grid { grid-template-columns: 1fr 1fr; } }
        input, select, textarea { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 16px; margin-bottom: 8px; box-sizing: border-box; }
        .dim-row { display: flex; gap: 5px; }
        .driver-select { width: 100%; background: #000; color: var(--accent); border: 1px solid #555; font-weight: bold; padding: 10px; }
        button.primary { width: 100%; padding: 18px; background: var(--accent); color: #000; font-weight: 900; border: none; cursor: pointer; border-radius: 4px; text-transform: uppercase; font-size: 18px; }
        .dispatch-card { background: var(--card); border: 1px solid #333; margin-bottom: 12px; border-radius: 8px; display: flex; flex-direction: column; }
        .card-body { padding: 12px; }
        .card-ctrl { background: #1c1c1c; padding: 12px; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .addr { font-weight: 800; font-size: 15px; margin: 4px 0; }
        .loc-tag { font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; background: #444; }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-size: 16px;">E&C COMMAND CENTER</h1>
    <div id="clock" style="font-size: 14px; font-weight: 800; color: var(--accent);"></div>
</header>

<div class="stats-bar">
    <div id="pending-box" class="stat-box">
        <span class="stat-label">Pending</span>
        <div id="stat-pending" class="stat-number">0</div>
    </div>
    <div class="stat-box"><span class="stat-label">Winnipeg</span><div id="stat-wpg" class="stat-number" style="color:var(--wpg)">0</div></div>
    <div class="stat-box"><span class="stat-label">Brandon</span><div id="stat-brdn" class="stat-number" style="color:var(--brdn)">0</div></div>
</div>

<div id="board-panel"><div id="job-list"></div></div>

<div id="entry-panel">
    <div class="form-grid">
        <div>
            <select id="f-city"><option value="Winnipeg">Winnipeg</option><option value="Brandon">Brandon</option></select>
            <input type="text" id="f-pickup" placeholder="Pickup Address">
            <input type="text" id="f-drop" placeholder="Drop Address">
        </div>
        <div>
            <div class="dim-row">
                <select id="f-type" style="flex: 2;"><option value="Box">Box</option><option value="Envelope">Envelope</option><option value="Pallet">Pallet</option></select>
                <input type="text" id="f-l" placeholder="L" style="flex:1"><input type="text" id="f-w" placeholder="W" style="flex:1"><input type="text" id="f-h" placeholder="H" style="flex:1">
            </div>
            <input type="text" id="f-po" placeholder="PO / Reference">
            <input type="text" id="f-name" placeholder="Contact Name">
        </div>
    </div>
    <textarea id="f-info" placeholder="Driver Notes..." rows="2"></textarea>
    <button class="primary" onclick="createJob()">Dispatch Job</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
        authDomain: "eandccourier-36fcc.firebaseapp.com",
        databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
        projectId: "eandccourier-36fcc"
    });
    const db = firebase.database();

    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }
    setInterval(updateClock, 1000);

    function createJob() {
        const pickup = document.getElementById('f-pickup').value;
        const drop = document.getElementById('f-drop').value;
        if(!pickup || !drop) return alert("Enter addresses");

        // REVERTED TO ORIGINAL NESTED STRUCTURE
        db.ref("pickups").push({
            city: document.getElementById('f-city').value,
            pickup_location: pickup,
            destination: drop,
            package_type: document.getElementById('f-type').value,
            dimensions: {
                length: document.getElementById('f-l').value || "-",
                width: document.getElementById('f-w').value || "-",
                height: document.getElementById('f-h').value || "-"
            },
            po_number: document.getElementById('f-po').value,
            name: document.getElementById('f-name').value,
            other_info: document.getElementById('f-info').value,
            status: 'pending',
            assigned_to: 'unassigned',
            timestamp: Date.now()
        });
        ['f-pickup', 'f-drop', 'f-po', 'f-info', 'f-l', 'f-w', 'f-h', 'f-name'].forEach(id => document.getElementById(id).value = "");
    }

    db.ref("pickups").on("value", snapshot => {
        const data = snapshot.val() || {};
        const list = document.getElementById("job-list"); list.innerHTML = "";
        let pending = 0, wpg = 0, bdn = 0;

        Object.entries(data).reverse().forEach(([id, p]) => {
            if(p.status === 'completed') return;
            if(p.city === 'Winnipeg') wpg++; else bdn++;
            if(p.assigned_to === 'unassigned') pending++;

            const card = document.createElement("div");
            card.className = "dispatch-card";
            card.innerHTML = `
                <div class="card-body">
                    <span class="loc-tag">${p.city}</span>
                    <div class="addr"><span style="color:var(--accent)">P:</span> ${p.pickup_location}</div>
                    <div class="addr"><span style="color:#888">D:</span> ${p.destination}</div>
                </div>
                <div class="card-ctrl">
                    ${p.assigned_to === 'unassigned' ? `
                        <select class="driver-select" onchange="assignDriver('${id}', this.value)">
                            <option value="unassigned" selected>ASSIGN DRIVER</option>
                            <option value="Driver 1 (WPG)">Driver 1 (WPG)</option>
                            <option value="Driver 2 (WPG)">Driver 2 (WPG)</option>
                            <option value="Cube Truck">Cube Truck</option>
                            <option value="Night Driver">Night Driver</option>
                        </select>` : `
                        <div style="color:var(--active-green); font-weight:900;">${p.assigned_to}</div>
                        <button onclick="unassign('${id}')">RESET</button>`}
                    <button onclick="deleteJob('${id}')" style="color:red;">X</button>
                </div>`;
            list.appendChild(card);
        });
        document.getElementById('stat-pending').innerText = pending;
        if(pending > 0) document.getElementById('pending-box').classList.add('high-alert');
        else document.getElementById('pending-box').classList.remove('high-alert');
        document.getElementById('stat-wpg').innerText = wpg;
        document.getElementById('stat-brdn').innerText = bdn;
    });

    function assignDriver(id, driver) { db.ref("pickups").child(id).update({ assigned_to: driver }); }
    function unassign(id) { db.ref("pickups").child(id).update({ assigned_to: 'unassigned' }); }
    function deleteJob(id) { if(confirm("Delete?")) db.ref("pickups").child(id).remove(); }
</script>
</body>
</html>